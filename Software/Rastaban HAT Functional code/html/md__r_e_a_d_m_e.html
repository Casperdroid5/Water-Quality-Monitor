<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Rastaban: TMC_2209_Raspberry_Pi</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="pcblogov0.2small.png"/></td>
  <td id="projectalign">
   <div id="projectname">Rastaban<span id="projectnumber">&#160;Alpha</span>
   </div>
   <div id="projectbrief">Documentation on the Rastaban software</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">TMC_2209_Raspberry_Pi </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a href="https://pypi.org/project/TMC-2209-Raspberry-Pi"><img src="https://badgen.net/pypi/python/TMC-2209-Raspberry-Pi" alt="PyPI python version TMC-2209-Raspberry-Pi" class="inline"/></a> <a href="https://pypi.org/project/TMC-2209-Raspberry-Pi"><img src="https://badgen.net/pypi/v/TMC-2209-Raspberry-Pi" alt="PyPI version TMC-2209-Raspberry-Pi" class="inline"/></a> <a href="https://pypi.org/project/TMC-2209-Raspberry-Pi"><img src="https://img.shields.io/pypi/dm/TMC-2209-Raspberry-Pi" alt="PyPI downloads TMC-2209-Raspberry-Pi" class="inline"/></a></p>
<p ><b>Function names have been changed to snake_case in 0.3</b> \ <b>Pin parameter order in constructor has changed in version 0.2 to EN, STEP, DIR !</b> \ \ This is a library to drive a stepper motor with a TMC2209 stepper driver and a Raspberry Pi</p>
<p >This code is still experimental, so use it on your own risk.</p>
<p >This library is programmed in pure Python. The performance of Python is not good enough to drive the motor with high speed. So if you move the motor with high speed and this library the motor will lose steps.</p>
<p >My TMC2209 is a <a href="https://github.com/bigtreetech/BIGTREETECH-TMC2209-V1.2">Bigtreetech TMC 2209 V1.2</a></p>
<p >It has a rSense of 110 mOhm and it uses one Pin (PDN_UART) for UART RX and TX. So the PD_UART-Pin needs to be connected to the Raspberrry Pis RX-Pin directly and to the TX-Pin with an 1kOhm resistor. You can read more about this in the datasheet from Trinamic.</p>
<p >Because the TMC2209 use one shared pin for transmit and receive in the UART communication line, the Raspberry Pi also receives what it sends. Well, the Pi receives 4 bytes from itself and 8 bytes from the driver. So the Pi receives a total of 12 bytes and only the last 8 are the reply, of which only 4 are data bytes.</p>
<p >the Documentation of the TMC2209 can be found here: <br  />
 <a href="https://www.trinamic.com/fileadmin/assets/Products/ICs_Documents/TMC2209_Datasheet_rev1.06.pdf">TMC2209 - Datsheet</a></p>
<p >the code is also available on <a href="https://pypi.org/project/TMC-2209-Raspberry-Pi">PyPI</a></p>
<h1><a class="anchor" id="autotoc_md1"></a>
Installation</h1>
<h2><a class="anchor" id="autotoc_md2"></a>
Installation with PIP</h2>
<div class="fragment"><div class="line">pip3 install TMC-2209-Raspberry-Pi</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md3"></a>
Installation with GIT</h2>
<ul>
<li>clone this repo to your Raspberry Pi using <br  />
 <div class="fragment"><div class="line">git clone https://github.com/Chr157i4n/TMC2209_Raspberry_Pi</div>
</div><!-- fragment --></li>
<li>install the python module bitstring with <br  />
 <div class="fragment"><div class="line">pip3 install bitstring</div>
</div><!-- fragment --></li>
<li>enable the serial port in <br  />
 <div class="fragment"><div class="line">sudo raspi-config</div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md4"></a>
Wiring</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Pin TMC2209   </th><th class="markdownTableHeadNone">connect to   </th><th class="markdownTableHeadNone">Function    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">TX or PDN_UART with 1kOhm   </td><td class="markdownTableBodyNone">TX of Raspberry Pi   </td><td class="markdownTableBodyNone">send data to TMC via UART    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">RX or PDN_UART directly   </td><td class="markdownTableBodyNone">RX of Raspberry Pi   </td><td class="markdownTableBodyNone">receive data from TMC via UART    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">VM   </td><td class="markdownTableBodyNone">12V or 24V of power supply   </td><td class="markdownTableBodyNone">power for the motor    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">GND   </td><td class="markdownTableBodyNone">GND of power supply   </td><td class="markdownTableBodyNone">power for the motor    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">VDD   </td><td class="markdownTableBodyNone">3,3V of Raspberry Pi   </td><td class="markdownTableBodyNone">optional, for more stable logic voltage    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">GND2   </td><td class="markdownTableBodyNone">GND of Raspberry Pi   </td><td class="markdownTableBodyNone">GND for VDD and Signals    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">EN   </td><td class="markdownTableBodyNone">GPIO21 of Raspberry Pi   </td><td class="markdownTableBodyNone">enable the motor output    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">STEP   </td><td class="markdownTableBodyNone">GPIO16 of Raspberry Pi   </td><td class="markdownTableBodyNone">moves the motor one step per pulse    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">DIR   </td><td class="markdownTableBodyNone">GPIO20 of Raspberry Pi   </td><td class="markdownTableBodyNone">set the direction of the motor    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">DIAG   </td><td class="markdownTableBodyNone">GPIO26 of Raspberry Pi   </td><td class="markdownTableBodyNone">optional, for StallGuard   </td></tr>
</table>
<p ><img src="docs/Images/wiring_diagram.png" alt="wiring diagram" class="inline"/></p>
<p >The GPIO pins can be specific when initiating the class. If you test this on a breadboard, make sure to cut off the bottomside of the pins (Vref and DIAG) next to the EN pin, so that they are not shorted trough the breadboard.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Tests</h1>
<p >You can run the test files from the main directory with </p><div class="fragment"><div class="line">python3 -m tests.test_script_01_uart_connection</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md6"></a>
&lt;a href="tests/test_script_01_uart_connection.py" &gt;test_script_01_uart_connection.py&lt;/a&gt;</h3>
<p >this only communicates with the TMC driver over UART. It should set some settings in the driver and then outputs the settings. When it outputs <code>TMC2209: UART Communication Error</code>, you need to check the UART-connection.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
&lt;a href="tests/test_script_02_pin_connection.py" &gt;test_script_02_pin_connection.py&lt;/a&gt;</h3>
<p >this scripts enables the raspberry GPIO output for the dir, en and step pin and then checks the tmc driver register, whether the driver sees them as HIGH or LOW. Because then enable pin is activated for a short time, the motor current ouput will be also activated in this script for a short time. This script should output: Pin DIR: OK Pin STEP: OK Pin EN: OK if not, check the connection of the pin</p>
<h3><a class="anchor" id="autotoc_md8"></a>
&lt;a href="tests/test_script_03_basic_movement.py" &gt;test_script_03_basic_movement.py&lt;/a&gt;</h3>
<p >this script should move the motor 6 times one revolution back and forth.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
&lt;a href="tests/test_script_04_stallguard.py" &gt;test_script_04_stallguard.py&lt;/a&gt;</h3>
<p >in this script the stallguard feature of the TMC2209 is beeing setup. a funtion will be called, if the driver detects a stall. the function stops the current movement. The motor will be moved 10 revolutions. If the movement is unhindered finished, the script outputs <code>Movement finished successfully</code>. If you block the motor with pliers or so, the the motor will stop and the script outputs <code>StallGuard!</code> and <code>Movement was not completed</code></p>
<h3><a class="anchor" id="autotoc_md10"></a>
&lt;a href="tests/test_script_05_vactual.py" &gt;test_script_05_vactual.py&lt;/a&gt;</h3>
<p >VACTUAL allows moving the motor by UART control. It gives the motor velocity in +-(2^23)-1 [μsteps / t]</p>
<h3><a class="anchor" id="autotoc_md11"></a>
&lt;a href="tests/test_script_06_multiple_drivers.py" &gt;test_script_06_multiple_drivers.py&lt;/a&gt;</h3>
<p >Multiple drivers can be addressed via UART by setting different addresses with the MS1 and MS2 pins. Simultaneous movement of multiple motors is currently not supported.</p>
<p >\ \ For me this baudrates worked fine: 19200, 38400, 57600, 115200, 230400, 460800, 576000</p>
<p >If the TMC2209 driver is connected to Vmotor, the internal voltage regulator will create the Vio for the chip. So you dont need to connect anything to the Vio pin of the driver.</p>
<h1><a class="anchor" id="autotoc_md12"></a>
Usage</h1>
<div class="fragment"><div class="line"><span class="keyword">from</span> TMC_2209.TMC_2209_StepperDriver <span class="keyword">import</span> *</div>
<div class="line">tmc = TMC_2209(21, 16, 20)</div>
<div class="line"> </div>
<div class="line">tmc.set_direction_reg(<span class="keyword">False</span>)</div>
<div class="line">tmc.set_current(300)</div>
<div class="line">tmc.set_interpolation(<span class="keyword">True</span>)</div>
<div class="line">tmc.set_spreadcycle(<span class="keyword">False</span>)</div>
<div class="line">tmc.set_microstepping_resolution(2)</div>
<div class="line">tmc.set_internal_rsense(<span class="keyword">False</span>)</div>
<div class="line"> </div>
<div class="line">tmc.set_acceleration(2000)</div>
<div class="line">tmc.set_max_speed(500)</div>
<div class="line"> </div>
<div class="line">tmc.set_motor_enabled(<span class="keyword">True</span>)</div>
<div class="line"> </div>
<div class="line">tmc.run_to_position_steps(400)</div>
<div class="line">tmc.run_to_position_steps(0)</div>
<div class="line"> </div>
<div class="line">tmc.set_motor_enabled(<span class="keyword">False</span>)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
Troubleshoot</h1>
<p >if you encounter any problem, feel free to open an issue</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Problem   </th><th class="markdownTableHeadNone">Solution    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">FileNotFoundError: [Errno 2] <br  />
 No such file or directory: '/dev/serial0'   </td><td class="markdownTableBodyNone">depending on your Raspberry Pi version, you need to enable the Serial Port <br  />
 run <code>sudo raspi-config</code> in your terminal. <br  />
 there go to '3 Interface Options' -&gt; 'P3 Serial Port' <br  />
 Would you like a login shell to be accessible over serial? No <br  />
 Would you like the serial port hardware to be enabled? Yes <br  />
 Finish and then reboot    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">PermissionError: [Errno 13] <br  />
 Permission denied: '/dev/serial0'   </td><td class="markdownTableBodyNone">you need to give the permission to acces the Serial Port to your current user <br  />
 You may need to add your user (pi) to the dialout group with <code>sudo usermod -a -G dialout pi</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">"TMC2209: UART Communication Error"   </td><td class="markdownTableBodyNone">You can use the 'debug_script_01_uart_connection' script to get a better reading on the received bytes and troubleshoot your problem    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">"TMC2209: UART Communication Error: 0 data bytes \| 4 total bytes"   </td><td class="markdownTableBodyNone">only 4 total bytes receives indicates, that the Raspberry Pi receives its own data, but nothing from the TMC driver. This happens if RX and TX are connected properly, but the TMC driver has no power    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">"TMC2209: UART Communication Error: 0 data bytes \| 0 total bytes"   </td><td class="markdownTableBodyNone">0 total bytes receives indicates, a problem with your wiring or your Raspberry Pi. This happens if TX is not connected    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">"TMC2209: UART Communication Error: 4 data bytes \| 12 total bytes"   </td><td class="markdownTableBodyNone">this indicates, the Raspberry Pi received only zeroes. This happens if only RX is connected and TX not    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">"the Raspberry Pi received only the sended bits" or<br  />
 inconsistent received bits   </td><td class="markdownTableBodyNone">Make sure the UART ist properly connected to the TMC driver and the driver is powered and working. <br  />
 Make sure login shell (console) over serial is disabled   </td></tr>
</table>
<p ><img src="docs/Images/image1.jpg" alt="wiring photo" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md14"></a>
Acknowledgements</h1>
<p >the code to run the stepper motor is based on the code of the <a href="http://www.airspayce.com/mikem/arduino/AccelStepper">AccelStepper Library from Mike McCauley</a></p>
<p >the code for the uart communication is based on this <a href="https://github.com/troxel/TMC_UART">code from troxel</a></p>
<p >My goal is to make a library, that can run a stepper motor with a TMC2209 stepper driver and can write the setting in the register of the TMC2209, entirly in Python. The main focus for this are Test setups, as Python is not fast enough for high motor speeds.</p>
<h1><a class="anchor" id="autotoc_md15"></a>
Feedback/Contributing</h1>
<p >If you encounter any problem, feel free to open an issue on the Github <a href="https://github.com/Chr157i4n/TMC2209_Raspberry_Pi/issues">issue page</a> Feedback will keep this project growing and I encourage all suggestions. feel free to submit a pull request on the dev branch </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
